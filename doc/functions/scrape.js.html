<!DOCTYPE html>
<html>
<head>
  <title>scrape.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../doc-style.css" />
  <script src="../doc-filelist.js"></script>
  <script>
    var relativeDir = "../";
    var thisFile = "functions\\scrape.js";
    var defaultSidebar = true;
  </script>
  <script src="../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>scrape.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-built_in">require</span>(<span class="hljs-string">'dotenv'</span>).config();
<span class="hljs-keyword">const</span> playwright = <span class="hljs-built_in">require</span>(<span class="hljs-string">'playwright-core'</span>);
<span class="hljs-keyword">const</span> { MongoClient } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongodb'</span>);
<span class="hljs-keyword">const</span> chromium = <span class="hljs-built_in">require</span>(<span class="hljs-string">'chrome-aws-lambda'</span>);

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addToDb</span>(<span class="hljs-params">data</span>) </span>{
  <span class="hljs-keyword">const</span> uri = process.env.MONGODB_URI;
  <span class="hljs-keyword">const</span> client = <span class="hljs-keyword">new</span> MongoClient(uri);

  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">await</span> client.connect();

    <span class="hljs-keyword">const</span> collection = client
      .db(process.env.MONGODB_DBNAME)
      .collection(process.env.MONGODB_COLLECTIONNAME);
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> collection.insertMany(data);

    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Inserted <span class="hljs-subst">${result.insertedCount}</span> documents into MongoDB`</span>);
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-built_in">console</span>.error(e);
  } <span class="hljs-keyword">finally</span> {
    <span class="hljs-keyword">await</span> client.close();
  }
}

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">scrapeWebsite</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Launching browser...'</span>);

  <span class="hljs-keyword">const</span> browser = <span class="hljs-keyword">await</span> playwright.chromium.launch({
    <span class="hljs-attr">executablePath</span>: process.env.CHROME_EXECUTABLE_PATH || <span class="hljs-keyword">await</span> chromium.executablePath,
    <span class="hljs-attr">headless</span>: chromium.headless,
  });

  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Browser launched!'</span>);

  <span class="hljs-keyword">const</span> context = <span class="hljs-keyword">await</span> browser.newContext({
    <span class="hljs-attr">userAgent</span>: <span class="hljs-string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'</span>,
    <span class="hljs-attr">locale</span>: <span class="hljs-string">'en-US'</span>,
    <span class="hljs-attr">timezoneId</span>: <span class="hljs-string">'America/New_York'</span>,
    <span class="hljs-attr">permissions</span>: [<span class="hljs-string">'geolocation'</span>],
    <span class="hljs-attr">geolocation</span>: { <span class="hljs-attr">latitude</span>: <span class="hljs-number">51.5074</span>, <span class="hljs-attr">longitude</span>: <span class="hljs-number">-0.1278</span> }, <span class="hljs-comment">// Set a default geolocation if needed</span>
  });

  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Opening new page...'</span>);
  <span class="hljs-keyword">const</span> page = <span class="hljs-keyword">await</span> context.newPage();
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'New page opened.'</span>);

  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Going to base page...'</span>);
  <span class="hljs-keyword">await</span> page.goto(<span class="hljs-string">'https://www.mql5.com/'</span>, { <span class="hljs-attr">waitUntil</span>: <span class="hljs-string">'domcontentloaded'</span> });
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'On base page'</span>);

  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Navigating to login page...'</span>);
  <span class="hljs-keyword">await</span> page.goto(<span class="hljs-string">'https://www.mql5.com/en/auth_login'</span>, { <span class="hljs-attr">waitUntil</span>: <span class="hljs-string">'domcontentloaded'</span> });
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'On login page'</span>);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>login</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">await</span> page.waitForSelector(<span class="hljs-string">'#Login'</span>);
  <span class="hljs-keyword">await</span> page.type(<span class="hljs-string">'#Login'</span>, process.env.MQL5_USERNAME);
  <span class="hljs-keyword">await</span> page.type(<span class="hljs-string">'#Password'</span>, process.env.MQL5_PASSWORD);
  <span class="hljs-keyword">await</span> page.click(<span class="hljs-string">'#loginSubmit'</span>);

  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Logged in successfully!'</span>);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>wait for navigation to complete</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">await</span> page.waitForNavigation({ <span class="hljs-attr">waitUntil</span>: <span class="hljs-string">'domcontentloaded'</span> });

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>go to the page to scrape</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">await</span> page.goto(<span class="hljs-string">'https://www.mql5.com/en/users/taherhalimi/feedbacks'</span>, { <span class="hljs-attr">waitUntil</span>: <span class="hljs-string">'domcontentloaded'</span> });

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>perform your scraping here...
after navigating to the page with the reviews...</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Extracting reviews...'</span>);
  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> page.evaluate(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> reviewElements = <span class="hljs-built_in">document</span>.querySelectorAll(<span class="hljs-string">'.rowLine'</span>); <span class="hljs-comment">// select each review element</span>
    <span class="hljs-keyword">let</span> reviews = []; <span class="hljs-comment">// this array will hold each review</span>

    reviewElements.forEach(<span class="hljs-function">(<span class="hljs-params">reviewElement</span>) =&gt;</span> {
      <span class="hljs-keyword">let</span> review = {};

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>Extract the rating</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">const</span> ratingElement = reviewElement.querySelector(<span class="hljs-string">'.rating-block-small__value'</span>);
      <span class="hljs-keyword">if</span> (ratingElement) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>count the number of <i> tags within the rating element</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">let</span> rating = ratingElement.getElementsByTagName(<span class="hljs-string">'i'</span>).length;
        review.rating = rating;
      }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>Extract the customer's name</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">const</span> nameElement = reviewElement.querySelector(<span class="hljs-string">'.author'</span>);
      <span class="hljs-keyword">if</span> (nameElement) {
        review.name = nameElement.innerText;
      }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>Extract the review message</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">const</span> messageElements = reviewElement.querySelectorAll(<span class="hljs-string">'.mainContainer &gt; span'</span>);
      <span class="hljs-keyword">if</span> (messageElements.length &gt; <span class="hljs-number">2</span>) {
        review.message = messageElements[<span class="hljs-number">2</span>].innerText;
      }

      reviews.push(review);
    });

    <span class="hljs-keyword">return</span> reviews;
  });

  <span class="hljs-keyword">await</span> browser.close();

  <span class="hljs-keyword">return</span> data;
}

exports.handler = <span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) </span>{
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Received event: '</span> + event);

  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> scrapeWebsite();
    <span class="hljs-built_in">console</span>.log(data);
    <span class="hljs-keyword">await</span> addToDb(data);
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">statusCode</span>: <span class="hljs-number">200</span>,
      <span class="hljs-attr">body</span>: <span class="hljs-string">'Scrape and data insert successful!'</span>,
    };
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-built_in">console</span>.error(err);
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">statusCode</span>: <span class="hljs-number">500</span>,
      <span class="hljs-attr">body</span>: <span class="hljs-string">'An error occurred'</span>,
    };
  }
};

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
